<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Make Payment | Oil ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png" />

  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .navbar-brand img { height: 40px; }
    .page-wrapper { animation: fadeInSlide 0.5s ease-in; }
    @keyframes fadeInSlide { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }
    .form-container { max-width: 700px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #preview_image { max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 6px; border: 1px solid #ccc; margin-top: 10px; display: block; }
    #upload-status { font-size: 0.9em; color: #086b2e; }
    .history-title { margin-top: 40px; font-weight: 600; }
    .badge-feedback { font-size: 0.85em; background-color: #e1f5fe; color: #0277bd; }
    .back-link { display: inline-flex; align-items: center; margin-bottom: 20px; color: #0d6efd; text-decoration: none; font-weight: 500; }
    .back-link i { margin-right: 6px; }
    .hint { font-size: .875rem; color: #6c757d; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm px-3">
  <a class="navbar-brand d-flex align-items-center" href="#">
    <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Oil ERP Logo" />
    <span class="ms-2 fw-bold text-primary"></span>
  </a>
</nav>

<div class="container page-wrapper">
  <a href="/client/dashboard" class="back-link mt-3"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>

  <!-- Payment Form -->
  <div class="form-container">
    <h4 class="text-center mb-3"><i class="bi bi-credit-card-2-back"></i> Make a Payment</h4>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" id="paymentForm">
      <!-- Payment Type -->
      <div class="mb-3">
        <label for="payment_type" class="form-label">Payment Type</label>
        <select name="payment_type" id="payment_type" class="form-select" required>
          <option value="">Select payment type</option>
          <option value="order">Order Payment</option>
          <option value="truck">Truck Payment</option>
        </select>
      </div>

      <!-- Orders with outstanding debt (Order Payment only) -->
      <div class="mb-3 d-none" id="order_field">
        <label for="order_id" class="form-label">Select Order (with outstanding)</label>
        <select name="order_id" id="order_id" class="form-select">
          <option value="">-- Select an order --</option>
          {% for o in orders_with_debt %}
            <option value="{{ o._id }}" data-outstanding="{{ o.outstanding }}">
              {{ o.code }} — {{ o.product }} — {{ o.date.strftime('%Y-%m-%d') if o.date }}
              — Outstanding: GHS {{ "{:,.2f}".format(o.outstanding) }}
            </option>
          {% endfor %}
        </select>
        {% if not orders_with_debt %}
          <div class="hint mt-1">You currently have no orders with outstanding debt.</div>
        {% endif %}
      </div>

      <!-- Quick full payment helper -->
      <div class="mb-3 d-flex align-items-center gap-2">
        <button type="button" id="fullPayBtn" class="btn btn-outline-dark btn-sm" title="Auto-fill total outstanding">
          <i class="bi bi-lightning-charge"></i> Full payment
        </button>
        <span class="hint">
          Total outstanding across your orders:
          <strong id="fullTotalText">GHS {{ "{:,.2f}".format(full_outstanding_total or 0) }}</strong>
        </span>
      </div>

      <!-- Amount -->
      <div class="mb-3">
        <label for="amount" class="form-label">Amount (GHS)</label>
        <input type="number" step="0.01" name="amount" id="amount" class="form-control" required>
        <div class="hint mt-1">Select an order to auto-fill its outstanding, or click <em>Full payment</em> to fill the total outstanding.</div>
      </div>

      <!-- Bank Select -->
      <div class="mb-3">
        <label for="bank_name" class="form-label">Bank Name</label>
        <select name="bank_name" id="bank_name" class="form-select" required>
          <option value="">Select a bank</option>
          {% for bank in bank_accounts %}
            <option value="{{ bank.bank_name }}" data-last4="{{ bank.account_number[-4:] }}">
              {{ bank.bank_name }} - {{ bank.account_name }} (****{{ bank.account_number[-4:] }})
            </option>
          {% endfor %}
        </select>
        <input type="hidden" name="account_last4" id="account_last4">
      </div>

      <!-- Proof Upload -->
      <div class="mb-3">
        <label for="image" class="form-label">Upload Payment Proof</label>
        <input type="file" id="image" accept="image/*" required class="form-control">
        <input type="hidden" name="proof_url" id="proof_url">
        <div id="upload-status" class="text-muted mt-2 d-flex align-items-center"></div>
        <img id="preview_image" src="" class="d-none mt-2">
      </div>

      <!-- Submit -->
      <div class="d-grid">
        <button type="submit" class="btn btn-success"><i class="bi bi-upload"></i> Submit Payment</button>
      </div>
    </form>
  </div>

  <!-- Payment History -->
  {% if payments %}
  <div class="form-container mt-4">
    <h5 class="history-title"><i class="bi bi-clock-history"></i> Payment History</h5>
    <div class="table-responsive mt-3">
      <table class="table table-bordered table-hover table-sm align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>Type</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Bank</th>
            <th>Status</th>
            <th>Proof</th>
            <th>Feedback</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payments %}
          <tr>
            <td><span class="badge bg-secondary">{{ p.type }}</span></td>
            <td>{{ p.date }}</td>
            <td>GHS {{ "{:,.2f}".format(p.amount or 0) }}</td>
            <td>{{ p.bank_name }}</td>
            <td>
              {% if p.status == "confirmed" %}
                <span class="badge bg-success">Confirmed</span>
              {% else %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% endif %}
            </td>
            <td>
              {% if p.proof_url %}
                <a href="{{ p.proof_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-eye"></i> View
                </a>
              {% else %}
                <span class="text-muted">No File</span>
              {% endif %}
            </td>
            <td>
              {% if p.feedback %}
                <span class="badge badge-feedback">{{ p.feedback }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>

<!-- Cloudinary Upload Script -->
<script>
  const imageInput = document.getElementById('image');
  const uploadStatus = document.getElementById('upload-status');
  const previewImage = document.getElementById('preview_image');
  const proofUrlInput = document.getElementById('proof_url');

  imageInput.addEventListener('change', async function (event) {
    const file = event.target.files[0];
    if (!file) return;

    uploadStatus.innerHTML = `Uploading... <div class="spinner-border text-success ms-2" role="status"><span class="visually-hidden">Loading...</span></div>`;
    previewImage.classList.add('d-none');

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'truetype');
    formData.append('folder', 'customer-images');

    try {
      const response = await fetch('https://api.cloudinary.com/v1_1/dl2ipzxyk/image/upload', { method: 'POST', body: formData });
      const data = await response.json();

      if (data.secure_url) {
        proofUrlInput.value = data.secure_url;
        previewImage.src = data.secure_url;
        previewImage.classList.remove('d-none');
        uploadStatus.innerHTML = '<i class="bi bi-check-circle-fill text-success me-2"></i> Upload successful.';
      } else {
        uploadStatus.innerHTML = '<i class="bi bi-x-circle-fill text-danger me-2"></i> Upload failed. Try again.';
      }
    } catch (error) {
      uploadStatus.innerHTML = '<i class="bi bi-x-circle-fill text-danger me-2"></i> Network error.';
      console.error(error);
    }
  });
</script>

<script>
  // Auto-fill last 4 digits
  document.getElementById('bank_name').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const last4 = selectedOption.getAttribute('data-last4') || '';
    document.getElementById('account_last4').value = last4;
  });
</script>

<script>
  // Toggle order/truck input based on payment type (null-safe for truck_field)
  const paymentType = document.getElementById('payment_type');
  const orderField  = document.getElementById('order_field');
  const truckField  = document.getElementById('truck_field'); // may not exist

  paymentType.addEventListener('change', () => {
    const selected = paymentType.value;
    if (selected === 'order') {
      orderField?.classList.remove('d-none');
      truckField?.classList.add('d-none');
    } else if (selected === 'truck') {
      truckField?.classList.remove('d-none');
      orderField?.classList.add('d-none');
    } else {
      truckField?.classList.add('d-none');
      orderField?.classList.add('d-none');
    }
  });

  // -------- No tojson needed: build from DOM --------
  const orderSelect   = document.getElementById('order_id');
  const amountInput   = document.getElementById('amount');
  const fullPayBtn    = document.getElementById('fullPayBtn');
  const fullTotalText = document.getElementById('fullTotalText');

  function parseNum(x) {
    const n = Number((x ?? '').toString().replace(/,/g, ''));
    return Number.isFinite(n) ? n : 0;
  }

  function getOrderOutstandingMap() {
    const map = {};
    if (!orderSelect) return map;
    [...orderSelect.options].forEach(opt => {
      if (!opt.value) return;
      map[opt.value] = parseNum(opt.getAttribute('data-outstanding'));
    });
    return map;
  }

  function getFullOutstanding() {
    if (!orderSelect) return 0;
    return [...orderSelect.options].reduce((sum, opt) => {
      if (!opt.value) return sum;
      return sum + parseNum(opt.getAttribute('data-outstanding'));
    }, 0);
  }

  function formatMoney(n) {
    return (Number(n) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  const orderMap       = getOrderOutstandingMap();
  let fullOutstanding  = getFullOutstanding();

  // Update hint text in case server didn't render it
  if (fullTotalText) {
    fullTotalText.textContent = `GHS ${formatMoney(fullOutstanding)}`;
  }

  if (orderSelect) {
    orderSelect.addEventListener('change', (e) => {
      const val = orderMap[e.target.value] || 0;
      amountInput.value = (val).toFixed(2);
    });
  }

  if (fullPayBtn) {
    fullPayBtn.addEventListener('click', () => {
      fullOutstanding = getFullOutstanding(); // recompute in case options changed
      amountInput.value = fullOutstanding.toFixed(2);
    });
  }
</script>

</body>
</html>
