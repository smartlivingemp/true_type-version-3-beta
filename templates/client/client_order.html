<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit Order | Oil ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" />

  <style>
    body {
      background: linear-gradient(to bottom right, #f4f6f9, #e9ecef);
      font-family: "Segoe UI", sans-serif;
    }
    .navbar-brand img { height: 40px; }
    .form-container {
      max-width: 900px; margin: 60px auto; background: #ffffff;
      padding: 40px 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.05);
    }
    .form-title { font-weight: 700; margin-bottom: 30px; color: #0d6efd; text-align: center; }
    label.form-label { font-weight: 500; }
    .btn-primary { background-color: #0d6efd; border: none; font-weight: 600; }
    .btn-primary:hover { background-color: #0b5ed7; }
    .back-link { display: inline-flex; align-items: center; margin-bottom: 20px; color: #0d6efd; text-decoration: none; }
    .back-link i { margin-right: 6px; }
    .alert { font-size: .95rem; }

    /* Price badge */
    .price-pill {
      display: none;
      font-weight: 600;
      border: 1px solid #0d6efd;
      background: #eef5ff;
      color: #0b5ed7;
      border-radius: 999px;
      padding: .35rem .75rem;
      white-space: nowrap;
    }
    @media (max-width: 575.98px){
      .price-pill { margin-top: .5rem; display: inline-block; }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm px-3">
  <a class="navbar-brand d-flex align-items-center" href="#">
    <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Logo">
    <span class="ms-2 fw-bold text-primary">Oil ERP</span>
  </a>
</nav>

<!-- Main Content -->
<div class="container">
  <div class="form-container">
    <a href="/client/dashboard" class="back-link"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
    <h3 class="form-title">Submit New Order</h3>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST">
      <div class="row g-3">
        <!-- Product + S-Price badge -->
        <div class="col-md-6">
          <label class="form-label d-flex align-items-center justify-content-between">
            <span>Product</span>
            <span id="sPriceBadge" class="price-pill">
              <i class="bi bi-tag me-1"></i>
              Selling Price: GHS <span id="sPriceVal">0.00</span>
            </span>
          </label>
          <select class="form-select" name="product" id="productSelect" required>
            <option value="">Select Product</option>
            {% for product in products %}
              <option
                value="{{ product.name }}"
                data-sprice="{{ '%.2f'|format(product.s_price or 0) }}"
                data-pprice="{{ '%.2f'|format(product.p_price or 0) }}"
              >
                {{ product.name }}{% if product.description %} - {{ product.description }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Quantity</label>
          <select class="form-select" name="quantity" id="quantity" required>
            <option value="">Select Quantity</option>
            <option value="13500">13,500</option>
            <option value="18000">18,000</option>
            <option value="27000">27,000</option>
            <option value="36000">36,000</option>
            <option value="40500">40,500</option>
            <option value="45000">45,000</option>
            <option value="54000">54,000</option>
          </select>
        </div>

        <!-- Truck Selection -->
        <div class="col-md-12">
          <label class="form-label">Hire Truck (Optional)</label>
          <select class="form-select" id="truck_selector">
            <option value="">-- Select Available Truck (Optional) --</option>
            {% for truck in trucks %}
              <option
                value="{{ truck.truck_number }}"
                data-driver="{{ truck.driver_name }}"
                data-phone="{{ truck.driver_phone }}"
                data-capacity="{{ truck.capacity }}"
              >
                {{ truck.truck_number }} - {{ truck.driver_name }} ({{ truck.capacity }}L)
              </option>
            {% endfor %}
          </select>
          <small class="text-muted">You may also enter truck details manually below.</small>
        </div>

        <div class="col-md-6">
          <label class="form-label">Vehicle Number</label>
          <input type="text" class="form-control" name="vehicle_number" id="vehicle_number" placeholder="Enter or select above" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Destination</label>
          <input type="text" class="form-control" name="region" placeholder="e.g. Western Region" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Driver's Name</label>
          <input type="text" class="form-control" name="driver_name" id="driver_name" placeholder="Enter or auto-filled from truck" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Driver's Phone</label>
          <input type="tel" class="form-control" name="driver_phone" id="driver_phone" placeholder="Enter or auto-filled from truck" required>
        </div>

        <div class="d-grid mt-4">
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-circle me-1"></i>Submit Order
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Truck selector autofill
  document.getElementById('truck_selector').addEventListener('change', function() {
    const opt = this.options[this.selectedIndex] || {};
    document.getElementById('vehicle_number').value = opt.value || '';
    document.getElementById('driver_name').value   = opt.getAttribute('data-driver') || '';
    document.getElementById('driver_phone').value  = opt.getAttribute('data-phone') || '';
    document.getElementById('quantity').value      = opt.getAttribute('data-capacity') || '';
  });

  // ---- S-Price badge handling ----
  const productSelect = document.getElementById('productSelect');
  const badge = document.getElementById('sPriceBadge');
  const badgeVal = document.getElementById('sPriceVal');

  function fmt(n){
    const num = Number(n);
    return Number.isFinite(num) ? num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
  }

  async function setPriceFromServer(name){
    try{
      const res = await fetch(`/client/product_price?name=${encodeURIComponent(name)}`);
      if (!res.ok) return null;
      const data = await res.json();
      if (data && data.success) return data.s_price ?? 0;
    }catch(e){ /* ignore */ }
    return null;
  }

  async function updatePriceBadge(){
    const opt = productSelect.options[productSelect.selectedIndex];
    if (!opt || !opt.value){
      badge.style.display = 'none';
      badgeVal.textContent = '0.00';
      return;
    }

    // Try data attribute first (fast path)
    let sprice = opt.getAttribute('data-sprice');
    if (!sprice || Number(sprice) <= 0){
      // Fallback to API (in case template didnâ€™t include s_price)
      const apiPrice = await setPriceFromServer(opt.value);
      if (apiPrice !== null) sprice = apiPrice;
    }

    if (sprice !== null && sprice !== undefined){
      badgeVal.textContent = fmt(sprice);
      badge.style.display = 'inline-flex';
    } else {
      badge.style.display = 'none';
    }
  }

  productSelect.addEventListener('change', updatePriceBadge);
  // Initialize on first load if a value is preselected
  updatePriceBadge();
</script>

</body>
</html>
