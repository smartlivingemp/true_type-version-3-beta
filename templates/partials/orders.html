<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orders</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- jQuery + Select2 + Bootstrap Bundle -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .card-header small { color:#6c757d; }
    .formula-chip { display:inline-block; padding:.2rem .6rem; border-radius:999px; background:#f1f3f5; font-size:.8rem; }
    .calc-note { font-size:.8rem; color:#6c757d; }
    .dimmed { opacity:.55; pointer-events:none; }
    .btn-toggle-group .btn { min-width: 92px; }
    .metric-box { background:#f8f9fa; border-radius:.5rem; padding:.5rem .75rem; }
    .metric-heading { font-size:.85rem; color:#6c757d; margin-bottom:.2rem; }
    .metric-value { font-weight:600; }
    @media (max-width: 576px){
      .form-label, .btn { font-size:.95rem; }
      .btn-toggle-group .btn { min-width: 31%; padding:.5rem .25rem; }
      .card-header .btn { width:100%; }
    }
  </style>
</head>

<body class="p-2 p-sm-3">
<h4 class="mb-3">Pending Orders</h4>
<div id="order-alert"></div>

{% if orders %}
  {% for order in orders %}
    {% set filled = order.total_debt and order.returns %}
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center flex-wrap gap-2">
          <div class="d-inline-flex align-items-center text-decoration-none">
            {% if order.client_image_url %}
              <img src="{{ order.client_image_url }}" alt="Client Image" class="rounded-circle me-2" width="32" height="32">
            {% else %}
              <div class="rounded-circle bg-secondary me-2" style="width:32px; height:32px;"></div>
            {% endif %}
            <strong>{{ order.client_name or 'Client' }} ({{ order.client_id }})</strong>
          </div>
          <small>• {{ order.product }} • {{ order.quantity }} L • {{ order.date or '' }}</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#detailsModal{{ order._id }}">
          View Details
        </button>
      </div>

      <div class="card-body">
        <form method="POST"
              action="/orders/update/{{ order._id }}"
              class="row g-3 order-update-form"
              data-id="{{ order._id }}"
              data-qty="{{ order.quantity|float }}">
          <!-- Order Type toggle -->
          <div class="col-12">
            <label class="form-label mb-1 d-flex justify-content-between align-items-center">
              Order Type:
              <span class="calc-note"></span>
            </label>
            <div class="btn-group btn-group-sm btn-toggle-group" role="group" aria-label="Order Type">
              {% set mode = order.order_type or 'combo' %}
              <button type="button" class="btn btn-outline-primary mode-btn {% if mode=='s_bdc' %}active{% endif %}" data-mode="s_bdc">S‑BDC</button>
              <button type="button" class="btn btn-outline-primary mode-btn {% if mode=='s_tax' %}active{% endif %}" data-mode="s_tax">S‑Tax</button>
              <button type="button" class="btn btn-outline-primary mode-btn {% if mode=='combo' %}active{% endif %}" data-mode="combo">Combo</button>
            </div>
            <input type="hidden" name="order_type" class="order_type" value="{{ mode }}">
          </div>

          <!-- Shareholder -->
          <div class="col-12 col-sm-6 col-lg-4">
            <label class="form-label">Shareholder</label>
            <select name="shareholder" class="form-select" required>
              <option value="">Select Shareholder</option>
              <option value="Rex"    {% if order.shareholder == 'Rex' %}selected{% endif %}>Rex</option>
              <option value="Simon"  {% if order.shareholder == 'Simon' %}selected{% endif %}>Simon</option>
              <option value="Paul"   {% if order.shareholder == 'Paul' %}selected{% endif %}>Paul</option>
              <option value="Neutral"{% if order.shareholder == 'Neutral' %}selected{% endif %}>Neutral</option>
            </select>
          </div>

          <!-- OMC -->
          <div class="col-12 col-sm-6 col-lg-4">
            <label class="form-label">OMC</label>
            <select name="omc" class="form-control omc-select" required>
              <option value="">Select OMC</option>
              {% set omcs = [
                "AEGIS HUILE COMPANY LIMITED","AGAPET LIMITED","AGETHA ENERGY LIMITED","AI ENERGY & PETROLEUM LIMITED",
                "AKARA ENERGY LIMITED","ALINCO OIL COMPANY LIMITED","ALIVE GAS SERVICES LIMITED",
                "ALLIED OIL COMPANY LIMITED","AMDAWAY OIL COMPANY LIMITED","AMINASER OIL COMPANY LIMITED",
                "AMINSO ENERGY LIMITED","ANASSET COMPANY LIMITED","ANDEV COMPANY LIMITED","ANNANDALE GHANA LIMITED",
                "AP OIL & GAS GHANA LIMITED","APRIL-OIL GHANA LTD","BAFFOUR GAS COMPANY LIMITED","BEAP ENERGY GHANA LIMITED",
                "BELLO PETROLEUM LIMITED","BENAB OIL COMPANY LIMITED","BF PETROLEUM LIMITED","BG PETROLEUM LIMITED",
                "BIGEN PETROLEUM LIMITED","BLANKO OIL COMPANY LIMITED","BLOOM PETROLEUM LIMITED",
                "BREEDLOVE COMPANY LIMITED","BRENT PETROLEUM LIMITED","BROGAN ENERGY LIMITED","BUFFALO OIL LIMITED",
                "CASH OIL COMPANY LIMITED","CD LOW PRICE MASTER LIMITED","CENT EASTERN GAS LIMITED",
                "CENTRAL BRENT PETROLEUM LIMITED","CHAMPION OIL CO. LTD","CIGO ENERGY LIMITED","COEGAN GHANA LIMITED",
                "COLONY ENERGY LTD","COMPASS OLEUM LIMITED","CONCORD OIL LIMITED","COST ENERGY LIMITED",
                "CROWN PETROLEUM GH. LTD","DA OIL COMPANY LIMITED","DABEMENS LTD","DAVIS PETROLEUM COMPANY LIMITED",
                "DEJON JONES LIMITED","DENZ ENERGY LIMITED","DESERT OIL GHANA LIMITED","DUKES PETROLEUM LIMITED",
                "EARTH ENERGY LIMITED","EDEN PETROLEUM LIMITED","E-HAN GROUP LTD","ENERGETIC PETROLEUM ENERGY LIMITED COMPANY",
                "ENGEN GHANA LTD","ESSENCE ENERGY COMPANY LIMITED","EV. OIL COMPANY LIMITED",
                "E-WINDSTAR PETROLEUM ENERGY LIMITED","EX OIL LIMITED","EXCEL OIL CO. LTD","EXPRESS PETROLEUM LIMITED",
                "EZA PETROLEUM GHANA LIMITED","FAMOUS ENERGY LIMITED","FINEST OIL COMPANY LIMITED","FIRST GAS CO. LTD.",
                "FRAGA OIL GH. LTD","FRIMPS OIL CO. LTD","FRONTIER OIL GHANA LIMITED","FUELIT ENERGIES LIMITED",
                "GAB ENERGY LIMITED","GAMMA PETROLEUM & ENERGY SERVICES LTD","GASO PETROLEUM LIMITED",
                "GAT OIL COMPANY LIMITED","GB OIL LIMITED","GLOBAL STANDARD PETROLEUM LIMITED","GLORY OIL CO. LTD",
                "GO-GAS VENTURES LIMITED","GOIL PLC","GOODNESS ENERGY LIMITED","GOWELL ENERGY LIMITED","GREEN GG7 LTD",
                "GREENWORLD OIL SERVICES LIMITED","GRID PETROLEUM GHANA LIMITED","GROUPE TRANSAFRICANA LIMITED",
                "GULF ENERGY GHANA LIMITED","HENOS ENERGY LIMITED","HILLS OIL MARKETING COMPANY LIMITED",
                "HUMANO ENERGY LIMITED","HUSS PETROLEUM LIMITED","IBM PETROLEUM LIMITED","ICON ENERGY LIMITED",
                "INFIN GHANA LIMITED","IZ SALSABILLA COMPANY LIMITED","JANDA GHANA LIMITED","JD- LINK OIL COMPANY LIMITED",
                "JET PETROLEUM SERVICES LTD","JO & JU ENERGY LIMITED","JOEKONA COMPANY LIMITED","JONES ENERGY LIMITED",
                "JP TRUSTEES LIMITED","JUSBRO PETROLEUM CO. LTD","KABORE OIL LIMITED",
                "KAN ROYAL SERVICE STATION & TRADING LIMITED","KAYSENS LTD","KI ENERGY LIMITED","KINGS ENERGY LIMITED",
                "KINGSPERP OIL LIMITED","KOANTWI COMPANY LIMITED","KTC ENERGY LIMITED",
                "L. LINK PETROLEUM COMPANY LIMITED","LA CLEM GHANA LIMITED","LAMBARK GAS COMPANY LIMITED",
                "LAMININ BEE VENTURES LIMITED","LIBERTY PETROLEUM LIMITED","LIFE ENERGY COMPANY LIMITED",
                "LIFE PETROLEUM COMPANY LIMITED","LISS PETROLEUM LIMITED","LONA PETROLEUM LIMITED",
                "LONESTAR GAS COMPANY LIMITED","LOUIS GAS COMPANY LIMITED","LUCKY OIL CO. LTD","MANBAH GAS COMPANY LIMITED",
                "MAXX ENERGY LIMITED","MAXX GAS LIMITED","MAXXON PETROLEUM LIMITED","MDS EXPRESS OIL & GAS LTD",
                "MERCY OIL MARKETING COMPANY LIMITED","MIDAS OIL & GAS LIMITED","MIGHTY GAS COMPANY LIMITED",
                "MM ENERGY LIMITED","MOARI OIL COMPANY LIMITED","MOBIK ENERGY LIMITED","MORE FUEL LTD",
                "MUNA ENERGY LIMITED","N3 LIMITED","NAAGAMNI GHANA LTD","NADDIF COMPANY LIMITED",
                "NASONA OIL COMPANY LIMITED","NEXT PETROLEUM LIMITED","NEXTBONS GAS LIMITED",
                "NICK PETROLEUM GHANA LIMITED","NKA ENERGY LIMITED","NORGAZ PETROLEUM LIMITED","NUJENIX COMPANY LIMITED",
                "NURU OIL COMPANY LIMITED","OCEAN OIL COMPANY LIMITED","OIL FAST GHANA LTD","OIL-SPACE GHANA LIMITED",
                "ONYXMA ENERGY LIMITED","P. K OIL & GAS COMPANY LTD","PACIFIC OIL GHANA LIMITED",
                "PATRICK K.A BONNEY & CO. LIMITED","PETRO SANKOFA LIMITED","PETROCELL LTD","PETROGY LIMITED",
                "PETROL XP GHANA LIMITED","PETROLAND LIMITED","PETRONAX ENERGY LIMITED",
                "PETROSOL PLATINUM ENERGY LIMITED.","PLUS ENERGY LIMITED","POWER FUEL DISTRIBUTION COMPANY LIMITED",
                "PRINCE ENERGY LIMITED","PUMA ENERGY DISTRIBUTION GHANA LIMITED","QUANTUM PETROLEUM LIMITED",
                "R&P OIL COMPANY LIMITED","RADIANCE PETROLEUM LIMITED","RAJIP OIL COMPANY LTD","RAZs OIL GHANA LIMITED",
                "READY OIL LIMITED","REFUEL ENERGY LTD","RELIANCE OIL LIMITED","RESTOL ENERGIES LTD",
                "RIEMA COMPANY LIMITED","RIK ENERGY LIMITED","RODO OIL LIMITED","ROOTSENAF GAS COMPANY LIMITED",
                "ROYAL ENERGY COMPANY LIMITED","RUNEL OIL LIMITED","S.L. ENERGY LIMITED","SAC ENERGY LIMITED COMPANY",
                "SAF HOPE COMPANY LTD","SAMA OIL COMPANY LIMITED","SANTOL ENERGY LIMITED","SAP OIL LIMITED",
                "SAWADIGO OIL COMPANY LIMITED","SAWIZ PETROLEUM COMPANY LIMITED","SAYON ENERGY COMPANY LIMITED",
                "SEAM OIL COMPANY LIMITED","SEMANHYIA OIL LIMITED","SHAKAINAH VENTURES LIMITED",
                "SHELLEYCO PETROLEUM LIMITED","SIGNAL OIL LIMITED","SMART & PARTNERS LIMITED","SO ENERGY GH LIMITED",
                "SONNIDOM  LIMITED","SOTEI ENERGY LIMITED","SPIRITS PETROLEUM LIMITED","STAR OIL CO. LTD",
                "STRATEGIC ENERGIES LIMITED","SUPERIOR OIL COMPANY LTD.","TEL ENERGY LIMITED","TELIOS ENERGY LIMITED",
                "THOMHCOF ENERGY LIMITED","TOP OIL COMPANY LIMITED","TORRID GLOBAL COMPANY LIMITED",
                "TOTALENERGIES MARKETING GHANA PLC","TRADE CROSS LIMITED","TRINITY OIL COMPANY LIMITED",
                "TRIPLE A LP GAS LIMITED","TRUGREEN PETROLEUM LTD","T-TEKPOR ENERGY LIMITED","UNICORN PERTROLEUM LIMITED",
                "UNIQUE OIL COMPANY LTD.","UNITY OIL COMPANY LIMITED","VENUS OIL COMPANY LIMITED",
                "VEROS PETROLEUM LIMITED","VIGGO ENERGY LIMITED","VIRGIN PETROLEUM LIMITED","VIVO ENERGY GHANA PLC",
                "WABENDSO ENERGIES LIMITED","WEST AFRICA PETROLEUM COMPANY LIMITED (WAPCO)","WEST PORT PETROLEUM LIMITED",
                "WESTOL PETROLEUM LIMITED","WHITE COAST ENERGY LTD","WORLD GAS COMPANY LIMITED",
                "XPRESS GAS LIMITED","YASS PETROLEUM COMPANY LIMITED","YOKWA GAS LIMITED","ZEN PETROLEUM LTD"
              ] %}
              {% for company in omcs %}
                <option value="{{ company }}" {% if order.omc == company %}selected{% endif %}>{{ company }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- BDC -->
          <div class="col-12 col-sm-6 col-lg-4">
            <label class="form-label">BDC</label>
            <select name="bdc" class="form-control bdc-select" required>
              <option value="">Select BDC</option>
              {% for b in bdcs %}
                <option value="{{ b._id }}" {% if order.bdc_id == b._id %}selected{% endif %}>{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Payment -->
          <div class="col-12" data-payment-section>
            <label class="form-label">Payment Details</label>
            <div class="row g-2 payment-type-group align-items-end">
              <div class="col-12 col-sm-6 col-lg-4">
                <select class="form-select payment-type-select" name="payment_type">
                  <option value="">Select Payment Type</option>
                  <option value="Cash">Cash</option>
                  <option value="Credit">Credit</option>
                  <option value="From Account">From Account</option>
                </select>
              </div>
              <div class="col-12 col-sm-6 col-lg-4 d-none payment-amount-wrapper">
                <input type="number" step="0.01" name="payment_amount" class="form-control"
                       placeholder="Auto: qty × P‑BDC" />
                <div class="form-text payment-amount-view text-muted"></div>
              </div>
            </div>
          </div>

          <!-- Depot -->
          <div class="col-12 col-sm-6 col-lg-4">
            <label class="form-label">DEPOT</label>
            <input type="text" name="depot" class="form-control" value="{{ order.depot or '' }}" required>
          </div>

          <!-- Prices -->
          <div class="col-12 col-sm-6 col-lg-4">
            <label class="form-label d-flex justify-content-between align-items-center flex-wrap gap-2">
              P‑BDC <span class="calc-note">For price margin & payments</span>
              <button type="button" class="btn btn-sm btn-outline-secondary fetch-price-btn"
                      data-product="{{ order.product }}" title="Auto-fill P/S Price">Use Existing Price</button>
            </label>
            <input type="number" step="0.01" name="p_bdc_omc" class="form-control p_bdc_input"
                   value="{{ order.p_bdc_omc or '' }}">
          </div>

          <div class="col-12 col-sm-6 col-lg-4">
            <label class="form-label">S‑BDC <span class="calc-note">Used in S‑BDC/Combo debt</span></label>
            <input type="number" step="0.01" name="s_bdc_omc" class="form-control s_bdc_input"
                   value="{{ order.s_bdc_omc or '' }}">
          </div>

          <!-- Taxes -->
          <div class="col-12 col-sm-6 col-lg-4">
            <label class="form-label">P‑Tax <span class="calc-note">For tax margin only</span></label>
            <input type="number" step="0.01" name="p_tax" class="form-control p_tax_input"
                   value="{{ order.p_tax or '' }}">
          </div>

          <div class="col-12 col-sm-6 col-lg-4">
            <label class="form-label">S‑Tax <span class="calc-note">Used in S‑Tax/Combo debt</span></label>
            <input type="number" step="0.01" name="s_tax" class="form-control s_tax_input"
                   value="{{ order.s_tax or '' }}">
          </div>

          <!-- Derived -->
          <div class="col-12 col-md-6 col-lg-4">
            <div class="metric-box">
              <div class="metric-heading">Price Margin (per L)</div>
              <input type="hidden" name="margin" class="margin_input" value="{{ order.margin or '' }}">
              <input type="text" class="form-control margin_view" value="" readonly>
            </div>
          </div>

          <div class="col-12 col-md-6 col-lg-4">
            <div class="metric-box">
              <div class="metric-heading">Tax Margin (per L)</div>
              <input type="hidden" name="margin_tax" class="margin_tax_input" value="{{ order.margin_tax or '' }}">
              <input type="text" class="form-control margin_tax_view" value="" readonly>
            </div>
          </div>

          <div class="col-12 col-md-6 col-lg-4">
            <div class="metric-box">
              <div class="metric-heading">Total Debt</div>
              <input type="hidden" name="total_debt" class="total_debt_input" value="{{ order.total_debt or '' }}">
              <input type="text" class="form-control total_debt_view" value="" readonly>
              <div class="mt-1">
                <span class="formula-chip debt-formula-chip">Formula: —</span><br>
                <small class="calc-note debt-preview">Q = {{ order.quantity|float }} → —</small>
              </div>
            </div>
          </div>

          <!-- RETURNS -->
          <div class="col-12">
            <div class="metric-box">
              <div class="metric-heading">Returns</div>
              <div class="row g-2">
                <div class="col-12 col-md-4">
                  <label class="form-label">S‑BDC × Q</label>
                  <div class="metric-value">GHS <span class="returns_sbdc_display">0.00</span></div>
                  <input type="hidden" name="returns_sbdc" class="returns_sbdc_input" value="">
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">S‑Tax × Q</label>
                  <div class="metric-value">GHS <span class="returns_stax_display">0.00</span></div>
                  <input type="hidden" name="returns_stax" class="returns_stax_input" value="">
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">Total Returns</label>
                  <div class="metric-value">GHS <span class="returns_total_display">{{ order.returns or '0.00' }}</span></div>
                  <input type="hidden" name="returns_total" class="returns_total_input" value="">
                  <input type="hidden" name="returns" class="returns_input" value="{{ order.returns or '' }}">
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-lg-4">
            <label class="form-label">Due Date</label>
            <input type="date" name="due_date" class="form-control"
                   value="{{ order.due_date.strftime('%Y-%m-%d') if order.due_date else '' }}">
          </div>

          <div class="col-12 col-lg-4 d-flex align-items-end">
            <button type="submit" class="btn btn-{{ 'success' if filled else 'primary' }} w-100">
              {{ 'Approve & Update' if filled else 'Update' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal fade" id="detailsModal{{ order._id }}" tabindex="-1"
         aria-labelledby="detailsModalLabel{{ order._id }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailsModalLabel{{ order._id }}">Order Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="list-group">
              <li class="list-group-item"><strong>Product:</strong> {{ order.product or 'N/A' }}</li>
              <li class="list-group-item"><strong>Vehicle Number:</strong> {{ order.vehicle_number or 'N/A' }}</li>
              <li class="list-group-item"><strong>Driver's Name:</strong> {{ order.driver_name or 'N/A' }}</li>
              <li class="list-group-item"><strong>Driver's Phone:</strong> {{ order.driver_phone or 'N/A' }}</li>
              <li class="list-group-item"><strong>Quantity:</strong> {{ order.quantity or 'N/A' }}</li>
              <li class="list-group-item"><strong>Region:</strong> {{ order.region or 'N/A' }}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">No pending orders to review.</div>
{% endif %}

<!-- Scripts -->
<script>
  // ---------- Helpers ----------
  function toNum(v){ const n = parseFloat(v); return Number.isFinite(n) ? n : 0; }
  function toFixed2(n){ n = Number(n); return Number.isFinite(n) ? n.toFixed(2) : '0.00'; }
  function fmt(n){ n = Number(n); return Number.isFinite(n) ? n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) : '0.00'; }

  // Enable/disable BDC select
  function setBDCState($form, disabled){
    const $bdc = $form.find('.bdc-select');
    // Remove 'required' if disabled; restore when enabled
    if (disabled){
      $bdc.prop('required', false);
      $bdc.val('').trigger('change'); // clear
      $bdc.prop('disabled', true).addClass('dimmed');
    } else {
      $bdc.prop('disabled', false).removeClass('dimmed');
      $bdc.prop('required', true);
    }
    // If using Select2, make sure it reflects disabled state
    if ($bdc.hasClass('select2-hidden-accessible')){
      $bdc.trigger('change.select2');
    }
  }

  // Enable/disable + required per order type
  function setModeUI($form, mode){
    $form.find('.mode-btn').removeClass('active');
    $form.find(`.mode-btn[data-mode="${mode}"]`).addClass('active');
    $form.find('.order_type').val(mode);

    const $p  = $form.find('.p_bdc_input');
    const $s  = $form.find('.s_bdc_input');
    const $pt = $form.find('.p_tax_input');
    const $st = $form.find('.s_tax_input');

    const on  = (el) => { el.prop('disabled', false).removeClass('dimmed'); };
    const off = (el) => { el.prop('disabled', true).addClass('dimmed'); };

    [$p,$s,$pt,$st].forEach($el => $el.prop('required', false)); // reset

    if (mode === 's_tax'){
      off($p); off($s); on($pt); on($st);
      $st.prop('required', true);
      // NEW: disable BDC when S‑Tax
      setBDCState($form, true);
    } else if (mode === 's_bdc'){
      on($p); on($s); off($pt); off($st);
      $s.prop('required', true);
      // enable BDC for S‑BDC
      setBDCState($form, false);
    } else { // combo
      on($p); on($s); on($pt); on($st);
      $s.prop('required', true); $st.prop('required', true);
      // enable BDC for Combo
      setBDCState($form, false);
    }

    setPaymentUI($form, mode); // payment follows order type
  }

  function computeDebtByMode(mode, s, sTax, q){
    let amount = 0, label = "—", preview = "—";
    if (mode === 'combo'){
      const perL = (s > 0 ? s : 0) + (sTax > 0 ? sTax : 0);
      amount = perL * q;
      label = "(S‑BDC + S‑Tax) × Q";
      preview = `Q = ${q.toLocaleString()} → (${toFixed2(s)} + ${toFixed2(sTax)}) × ${q.toLocaleString()} = ${fmt(amount)}`;
    } else if (mode === 's_bdc'){
      amount = s * q;
      label = "S‑BDC × Q";
      preview = `Q = ${q.toLocaleString()} → ${toFixed2(s)} × ${q.toLocaleString()} = ${fmt(amount)}`;
    } else if (mode === 's_tax'){
      amount = sTax * q;
      label = "S‑Tax × Q";
      preview = `Q = ${q.toLocaleString()} → ${toFixed2(sTax)} × ${q.toLocaleString()} = ${fmt(amount)}`;
    }
    return { amount, label, preview };
  }

  // Compute derived values
  function computeFormValues($form){
    const p    = toNum($form.find('.p_bdc_input').val());
    const s    = toNum($form.find('.s_bdc_input').val());
    const pTax = toNum($form.find('.p_tax_input').val());
    const sTax = toNum($form.find('.s_tax_input').val());
    const q    = toNum($form.data('qty'));
    const mode = ($form.find('.order_type').val() || 'combo');

    // margins per L
    const marginPrice = s - p;       // price margin per L
    const marginTax   = sTax - pTax; // tax margin per L

    // returns
    const returnsSbdc = s * q;       // S‑BDC × Q
    const returnsStax = sTax * q;    // S‑Tax × Q
    const returnsTotal = returnsSbdc + returnsStax;

    // debt depends on order type
    const debtObj = computeDebtByMode(mode, s, sTax, q);

    // write raw values to hidden inputs
    $form.find('.margin_input').val(toFixed2(marginPrice));
    $form.find('.margin_tax_input').val(toFixed2(marginTax));
    $form.find('.returns_sbdc_input').val(toFixed2(returnsSbdc));
    $form.find('.returns_stax_input').val(toFixed2(returnsStax));
    $form.find('.returns_total_input').val(toFixed2(returnsTotal));
    $form.find('.returns_input').val(toFixed2(returnsTotal)); // legacy "returns"
    $form.find('.total_debt_input').val(toFixed2(debtObj.amount));

    // update formatted display fields
    $form.find('.margin_view').val(fmt(marginPrice));
    $form.find('.margin_tax_view').val(fmt(marginTax));
    $form.find('.returns_sbdc_display').text(fmt(returnsSbdc));
    $form.find('.returns_stax_display').text(fmt(returnsStax));
    $form.find('.returns_total_display').text(fmt(returnsTotal));
    $form.find('.total_debt_view').val(fmt(debtObj.amount));

    // formula chip + preview
    $form.find('.debt-formula-chip').text(`Formula: ${debtObj.label}`);
    $form.find('.debt-preview').text(debtObj.preview);

    // Payment helper (AUTOFILL for ALL three types)
    const payType = ($form.find('.payment-type-select').val() || '').toLowerCase();
    if (payType === 'cash' || payType === 'from account' || payType === 'credit') {
      const payAmt = q * p;
      $form.find('input[name="payment_amount"]').val(toFixed2(payAmt));
      $form.find('.payment-amount-view').text(`= ${fmt(payAmt)} GHS`);
      // ensure wrapper visible when any type chosen (except s_tax which is handled in setPaymentUI)
      $form.find('.payment-amount-wrapper').removeClass('d-none');
    } else {
      $form.find('.payment-amount-view').text('');
      // keep wrapper visibility managed by setPaymentUI
    }
  }

  function setPaymentUI($form, mode){
    const $typeSel = $form.find('.payment-type-select');
    const $amtWrap = $form.find('.payment-amount-wrapper');
    const $amtInp  = $form.find('input[name="payment_amount"]');

    if (mode === 's_tax'){
      // Disable everything & clear values; nothing will be submitted
      $typeSel.val('').prop('disabled', true).prop('required', false).addClass('dimmed');
      $amtInp.val('').prop('disabled', true).prop('required', false);
      $amtWrap.addClass('d-none');
      $form.find('.payment-amount-view').text('');
    } else {
      // Re-enable type select; amount shows for ANY chosen type
      $typeSel.prop('disabled', false).removeClass('dimmed');
      $typeSel.prop('required', false);
      $amtInp.prop('required', false).prop('disabled', false);
      const hasType = ($typeSel.val() || '').length > 0;
      $amtWrap.toggleClass('d-none', !hasType);
    }
  }

  // ---------- Events ----------
  $(document).on('click', '.mode-btn', function(){
    const $form = $(this).closest('form');
    setModeUI($form, $(this).data('mode'));
    computeFormValues($form);
  });

  $(document).on('input', '.p_bdc_input, .s_bdc_input, .p_tax_input, .s_tax_input', function(){
    const $form = $(this).closest('form');
    computeFormValues($form);
  });

  $(document).on('change', '.payment-type-select', function () {
    const $form = $(this).closest('form');
    setPaymentUI($form, $form.find('.order_type').val() || 'combo');
    computeFormValues($form);
  });

  // Autofill price button (P & S)
  $(document).on('click', '.fetch-price-btn', function () {
    const btn = $(this);
    const product = btn.data('product');
    const $form = btn.closest('form');

    $.get('/orders/get_product_price', { name: product })
      .done(function (res) {
        if (res.p_price != null) $form.find('.p_bdc_input').val(res.p_price);
        if (res.s_price != null) $form.find('.s_bdc_input').val(res.s_price);
        computeFormValues($form);
      })
      .fail(function (xhr) {
        const err = xhr.responseJSON?.error || 'Failed to fetch price';
        alert(err);
      });
  });

  // Init select2 + initial compute
  $(document).ready(function () {
    $('.omc-select, .bdc-select').each(function () {
      const $modal = $(this).closest('.modal');
      $(this).select2({
        placeholder: "Select or search...",
        dropdownParent: $modal.length ? $modal : $(document.body),
        width: '100%'
      });
    });

    $('.order-update-form').each(function(){
      const $form = $(this);
      const mode = $form.find('.order_type').val() || 'combo';
      setModeUI($form, mode);
      computeFormValues($form);
    });
  });

  // Submit (keep disabled inputs disabled so they won't serialize)
  $(document).on('submit', '.order-update-form', function (e) {
    e.preventDefault();
    const $form = $(this);

    $.post(`/orders/update/${$form.data('id')}`, $form.serialize())
      .done(function (res) {
        $('#order-alert').html(`<div class="alert alert-success">${res.message}</div>`);
        setTimeout(() => loadContent('/orders', 'Review Orders'), 800);
      })
      .fail(function (xhr) {
        const err = xhr.responseJSON?.error || 'Failed to update order.';
        $('#order-alert').html(`<div class="alert alert-danger">${err}</div>`);
      });
  });
</script>
</body>
</html>
