<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --brand-wa:#25D366;
      --brand-fb:#1877F2;
      --brand-tg:#229ED9;
      --brand-sms:#6c757d;
      --brand-mail:#ea4335;
    }
    body { background:#f6f8fb; }
    .card h5 { word-break: break-word; }
    .price { font-variant-numeric: tabular-nums; }
    .btn-icon { display:inline-flex; align-items:center; gap:.5rem; }
    .chip { background:#eef2ff; color:#3730a3; border-radius:999px; padding:2px 10px; font-size:.8rem; }

    /* Share modal tweaks */
    .share-channel { border:1px solid #e9ecef; background:#fff; border-radius:10px; padding:.6rem .8rem; display:flex; align-items:center; gap:.5rem; cursor:pointer; }
    .share-channel svg { width:20px; height:20px; }
    .share-channel.active { outline:2px solid #0d6efd; background:#f8fbff; }
    .client-list { max-height: 50vh; overflow:auto; border:1px solid #e9ecef; border-radius:.5rem; background:#fff; }
    .client-item { display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; }
    .client-item:hover { background:#f8f9fa; }
    .client-list-header { position:sticky; top:0; background:#f8f9fa; border-bottom:1px solid #e9ecef; padding:.5rem .75rem; z-index:1; }
    .form-hint { font-size:.86rem; color:#6c757d; }

    /* Icon color helpers */
    .wa svg path { fill: var(--brand-wa); }
    .fb svg path { fill: var(--brand-fb); }
    .tg svg path { fill: var(--brand-tg); }
    .sms svg path { fill: var(--brand-sms); }
    .mail svg path { fill: var(--brand-mail); }

    /* Small improvements */
    .card .btn { white-space: nowrap; }
  </style>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h3 class="mb-0">üõ¢Ô∏è Manage Products</h3>
    <span class="text-muted small">Share prices to clients via WhatsApp, Facebook & more</span>
  </div>

  <!-- Add Product Form -->
  <form id="addProductForm" class="card shadow-sm p-4 mb-4 bg-white rounded">
    <h5 class="mb-3">Add New Product</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <input type="text" name="name" class="form-control" placeholder="Product Name" required>
      </div>
      <div class="col-md-3">
        <input type="number" name="s_price" class="form-control" placeholder="S-Price" required step="0.01">
      </div>
      <div class="col-md-3">
        <input type="number" name="p_price" class="form-control" placeholder="P-Price" required step="0.01">
      </div>
      <div class="col-12">
        <textarea name="description" class="form-control" placeholder="Description (optional)" rows="2"></textarea>
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary mt-2">Add Product</button>
      </div>
    </div>
  </form>

  <!-- Product List -->
  <div class="row" id="productList"></div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editProductForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="product_id">
        <div class="mb-3">
          <input type="text" name="name" class="form-control" placeholder="Product Name" required>
        </div>
        <div class="mb-3">
          <input type="number" name="s_price" class="form-control" placeholder="S-Price" required step="0.01">
        </div>
        <div class="mb-3">
          <input type="number" name="p_price" class="form-control" placeholder="P-Price" required step="0.01">
        </div>
        <div class="mb-3">
          <textarea name="description" class="form-control" placeholder="Description (optional)" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Price Trend Modal -->
<div class="modal fade" id="priceTrendModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìà Price Trend</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="priceTrendChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Share Modal (responsive fullscreen on small screens) -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
    <form id="shareForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title d-flex align-items-center gap-2">
          <span>Share Price</span>
          <span class="badge text-bg-light" id="shareProductNameBadge" hidden></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="shareProductId" name="product_id">
        <input type="hidden" id="shareUrl" value="">

        <!-- Channels -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Channel</label>
          <div class="row g-2" id="channelRow" role="tablist" aria-label="Share channels">
            <div class="col-6 col-md-auto">
              <button type="button" class="share-channel wa active" data-channel="whatsapp" aria-selected="true">
                <!-- WhatsApp logo -->
                <svg viewBox="0 0 32 32" aria-hidden="true"><path d="M19.11 17.18c-.31-.15-1.83-.9-2.11-1.01-.28-.1-.49-.15-.7.16-.21.31-.8 1.01-.98 1.22-.18.21-.36.24-.67.09-.31-.15-1.31-.48-2.49-1.53-.92-.82-1.54-1.84-1.72-2.15-.18-.31-.02-.48.13-.63.13-.13.31-.34.46-.51.15-.17.2-.29.31-.5.1-.21.05-.38-.02-.53-.07-.15-.7-1.69-.96-2.32-.25-.6-.51-.52-.7-.53l-.6-.01c-.21 0-.53.08-.81.38-.28.31-1.07 1.05-1.07 2.56 0 1.51 1.1 2.96 1.26 3.17.15.2 2.16 3.3 5.23 4.63.73.31 1.3.5 1.74.64.73.23 1.4.2 1.93.12.59-.09 1.83-.75 2.09-1.47.26-.72.26-1.34.18-1.47-.08-.13-.28-.2-.59-.35zM16.02 3.2c-7.1 0-12.86 5.76-12.86 12.86 0 2.27.61 4.5 1.78 6.46L3 29l6.66-1.75a12.8 12.8 0 0 0 6.36 1.67h.01c7.1 0 12.86-5.76 12.86-12.86 0-3.44-1.34-6.67-3.78-9.1a12.79 12.79 0 0 0-9.09-3.76zm0 23.36h-.01a10.47 10.47 0 0 1-5.33-1.45l-.38-.22-3.95 1.04 1.05-3.85-.25-.39a10.48 10.48 0 1 1 9.87 4.87z"/></svg>
                <span>WhatsApp</span>
              </button>
            </div>
            <div class="col-6 col-md-auto">
              <button type="button" class="share-channel fb" data-channel="facebook" aria-selected="false">
                <!-- Facebook logo -->
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12.07C22 6.48 17.52 2 11.93 2 6.34 2 1.86 6.48 1.86 12.07c0 4.96 3.62 9.08 8.35 9.93v-7.02H7.9v-2.9h2.31v-2.21c0-2.28 1.36-3.54 3.45-3.54.999 0 2.04.18 2.04.18v2.25h-1.15c-1.13 0-1.48.7-1.48 1.42v1.9h2.53l-.4 2.9h-2.13V22c4.73-.85 8.35-4.97 8.35-9.93z"/></svg>
                <span>Facebook</span>
              </button>
            </div>
            <div class="col-6 col-md-auto">
              <button type="button" class="share-channel tg" data-channel="telegram" aria-selected="false">
                <!-- Telegram logo -->
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9.036 15.396 8.87 19.1c.33 0 .47-.144.64-.317l1.53-1.472 3.173 2.33c.582.321 1.004.152 1.166-.54l2.112-9.26c.215-.927-.335-1.29-.9-1.064L4.53 11.72c-.9.352-.887.861-.153 1.09l3.52 1.097 8.163-5.15c.384-.248.735-.111.447.137z"/></svg>
                <span>Telegram</span>
              </button>
            </div>
            <div class="col-6 col-md-auto">
              <button type="button" class="share-channel sms" data-channel="sms" aria-selected="false">
                <!-- SMS icon -->
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 2H4a2 2 0 0 0-2 2v15.5a1.5 1.5 0 0 0 2.31 1.26L8 18h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2zm-2 9H6V9h12v2zm0-4H6V5h12v2zm-5 8H6v-2h7v2z"/></svg>
                <span>SMS</span>
              </button>
            </div>
            <div class="col-6 col-md-auto">
              <button type="button" class="share-channel mail" data-channel="email" aria-selected="false">
                <!-- Email icon -->
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 4H4c-1.1 0-2 .9-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 4-8 5L4 8V6l8 5 8-5v2z"/></svg>
                <span>Email</span>
              </button>
            </div>
          </div>
          <div class="form-hint mt-2" id="channelHint">WhatsApp opens one chat per selected client. You‚Äôll tap <b>Send</b> in each chat.</div>
        </div>

        <!-- Message -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Message</label>
          <textarea id="shareMessage" class="form-control" rows="4" required></textarea>
          <div class="d-flex gap-2 mt-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnCopyMessage">Copy message</button>
            <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="btnCopyLinks">Copy all WhatsApp links</button>
          </div>
        </div>

        <!-- Clients Picker -->
        <div class="mb-2 d-flex align-items-center justify-content-between">
          <label class="form-label fw-semibold mb-0">Select Clients</label>
          <div class="d-flex align-items-center gap-2">
            <input type="text" id="clientSearch" class="form-control form-control-sm" placeholder="Search clients..." style="max-width:220px;">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnSelectAll">Select All</button>
            <span class="chip" id="selectedCount">0 selected</span>
          </div>
        </div>
        <div class="client-list" id="clientList" aria-live="polite">
          <div class="client-list-header d-flex align-items-center justify-content-between">
            <span class="text-muted small">Only clients with WhatsApp numbers are shown</span>
            <span class="text-muted small" id="clientTotal"></span>
          </div>
          <!-- items injected -->
        </div>
      </div>

      <div class="modal-footer flex-wrap gap-2">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" type="submit" id="btnShareNow">
          <span id="btnShareLabel">Share via WhatsApp</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let productsById = new Map();
let priceChart;
let currentChannel = 'whatsapp';
let lastBuiltLinks = []; // for "Copy all WhatsApp links"

function money(n){ return Number(n || 0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
function toast(msg, type='info'){
  const el = document.createElement('div');
  el.className = `alert alert-${type} position-fixed top-0 end-0 m-3 shadow`;
  el.style.zIndex = 1080;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 3200);
}

function setChannel(ch){
  currentChannel = ch;
  document.querySelectorAll('.share-channel').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.channel === ch);
    btn.setAttribute('aria-selected', btn.dataset.channel === ch ? 'true':'false');
  });

  const picker = document.getElementById('clientList').parentElement; // section wrapper
  const hint = document.getElementById('channelHint');
  const shareLabel = document.getElementById('btnShareLabel');
  const copyLinksBtn = document.getElementById('btnCopyLinks');

  if (ch === 'whatsapp') {
    picker.style.display = '';
    hint.innerHTML = 'WhatsApp opens one chat per selected client. You‚Äôll tap <b>Send</b> in each chat.';
    shareLabel.textContent = 'Share via WhatsApp';
    copyLinksBtn.classList.remove('d-none');
  } else if (ch === 'sms') {
    picker.style.display = '';
    hint.textContent = 'SMS will open your Messages app. One message per selected client.';
    shareLabel.textContent = 'Share via SMS';
    copyLinksBtn.classList.add('d-none');
  } else if (ch === 'facebook') {
    picker.style.display = 'none';
    hint.textContent = 'Facebook share opens a single dialog with your message and link.';
    shareLabel.textContent = 'Share to Facebook';
    copyLinksBtn.classList.add('d-none');
  } else if (ch === 'telegram') {
    picker.style.display = 'none';
    hint.textContent = 'Telegram share opens a single sheet where you can choose a chat.';
    shareLabel.textContent = 'Share to Telegram';
    copyLinksBtn.classList.add('d-none');
  } else if (ch === 'email') {
    picker.style.display = 'none';
    hint.textContent = 'Email share opens your mail client with a prefilled subject and body.';
    shareLabel.textContent = 'Share via Email';
    copyLinksBtn.classList.add('d-none');
  }
}

document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.share-channel');
  if (!btn) return;
  setChannel(btn.dataset.channel);
});

// ---------- Load & Render Products ----------
function loadProducts() {
  $.get('/products/load', function(data) {
    productsById.clear();
    const list = $('#productList').empty();

    if (!data || !data.length){
      list.append('<div class="col-12"><div class="alert alert-light border">No products yet.</div></div>');
      return;
    }

    data.forEach(product => {
      productsById.set(product._id, product);
      list.append(`
        <div class="col-md-4">
          <div class="card shadow-sm mb-4 h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="mb-2">${product.name}</h5>
              <p class="mb-1 price"><strong>S-Price:</strong> GHS ${money(product.s_price)}</p>
              <p class="mb-1 price"><strong>P-Price:</strong> GHS ${money(product.p_price)}</p>
              <p class="text-muted flex-grow-1">${product.description || 'No description'}</p>
              <div class="d-flex justify-content-between mt-3 gap-2 flex-wrap">
                <button class="btn btn-sm btn-warning btn-edit" data-id="${product._id}">Edit</button>
                <button class="btn btn-sm btn-info btn-trend" data-id="${product._id}">üìà Trend</button>
                <button class="btn btn-sm btn-success btn-share" data-id="${product._id}">Share</button>
                <button class="btn btn-sm btn-danger btn-delete" data-id="${product._id}">Delete</button>
              </div>
            </div>
          </div>
        </div>
      `);
    });
  });
}

// ---------- Edit ----------
$(document).on('click', '.btn-edit', function(){
  const id = $(this).data('id');
  const product = productsById.get(String(id));
  if(!product) return;

  const form = $('#editProductForm');
  form.find('[name="product_id"]').val(product._id);
  form.find('[name="name"]').val(product.name);
  form.find('[name="s_price"]').val(product.s_price);
  form.find('[name="p_price"]').val(product.p_price);
  form.find('[name="description"]').val(product.description || '');
  new bootstrap.Modal(document.getElementById('editModal')).show();
});

$('#editProductForm').on('submit', function(e){
  e.preventDefault();
  const id = $(this).find('[name="product_id"]').val();
  const formData = {
    name: $(this).find('[name="name"]').val(),
    s_price: $(this).find('[name="s_price"]').val(),
    p_price: $(this).find('[name="p_price"]').val(),
    description: $(this).find('[name="description"]').val()
  };
  $.ajax({
    url: `/products/update/${id}`,
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(formData),
    success: () => {
      $('#editModal').modal('hide');
      toast('Product updated','success');
      loadProducts();
    },
    error: () => toast('Update failed','danger')
  });
});

// ---------- Delete ----------
$(document).on('click', '.btn-delete', function(){
  const id = $(this).data('id');
  if (!confirm('Delete this product?')) return;
  $.ajax({
    url: `/products/delete/${id}`,
    method: 'DELETE',
    success: (res) => {
      if(res && res.success){ toast('Deleted','success'); loadProducts(); }
      else toast('Delete failed','danger');
    },
    error: () => toast('Delete failed','danger')
  });
});

// ---------- Trend ----------
function renderTrend(product){
  const ctx = document.getElementById('priceTrendChart').getContext('2d');
  const labels = (product.price_history || []).map(p => p.date);
  const s_prices = (product.price_history || []).map(p => p.s_price);
  const p_prices = (product.price_history || []).map(p => p.p_price);

  if (priceChart) priceChart.destroy();

  priceChart = new Chart(ctx, {
    type: 'line',
    data: { labels,
      datasets: [
        { label: 'S-Price', data: s_prices, borderColor: '#0d6efd', fill: false, tension: .3 },
        { label: 'P-Price', data: p_prices, borderColor: '#198754', fill: false, tension: .3 }
      ] },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: `Price Trend for ${product.name}` },
        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: GHS ${money(ctx.parsed.y)}` } }
      },
      scales: { y: { ticks: { callback: (v)=> 'GHS ' + money(v) } } }
    }
  });
}

$(document).on('click', '.btn-trend', function(){
  const id = $(this).data('id');
  const product = productsById.get(String(id));
  if (!product) return;
  renderTrend(product);
  new bootstrap.Modal(document.getElementById('priceTrendModal')).show();
});

// ---------- Add ----------
$('#addProductForm').on('submit', function(e) {
  e.preventDefault();
  const formData = {
    name: $(this).find('[name="name"]').val(),
    s_price: $(this).find('[name="s_price"]').val(),
    p_price: $(this).find('[name="p_price"]').val(),
    description: $(this).find('[name="description"]').val()
  };
  $.ajax({
    url: '/products/add',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(formData),
    success: () => { this.reset(); toast('Product added','success'); loadProducts(); },
    error: () => toast('Add failed','danger')
  });
});

// ---------- Share: Clients Loader ----------
let cachedClients = []; // { _id, name, primary_wa, wa_numbers[] }

async function loadClients(){
  try{
    const res = await fetch('/products/clients');
    const data = await res.json();
    cachedClients = Array.isArray(data) ? data : [];
    renderClientList();
  }catch(e){ toast('Failed to load clients','danger'); }
}

function renderClientList(filter=''){
  const box = document.getElementById('clientList');
  const totalEl = document.getElementById('clientTotal');
  box.querySelectorAll('.client-item').forEach(n=>n.remove());

  const term = filter.trim().toLowerCase();
  const view = cachedClients.filter(c => !term || (c.name || '').toLowerCase().includes(term));

  view.forEach(c=>{
    const label = `${c.name || '‚Äî'} ‚Äî ${c.primary_wa || ''}`;
    const item = document.createElement('label');
    item.className = 'client-item';
    item.innerHTML = `
      <input type="checkbox" class="form-check-input me-2 client-check" value="${c._id}" data-wa="${c.primary_wa || ''}">
      <span>${label}</span>`;
    box.appendChild(item);
  });
  totalEl.textContent = `${view.length} shown`;
  updateSelectedCount();
}

function updateSelectedCount(){
  const n = document.querySelectorAll('#clientList .client-check:checked').length;
  document.getElementById('selectedCount').textContent = `${n} selected`;
}

$('#clientSearch').on('input', function(){ renderClientList(this.value); });
$('#btnSelectAll').on('click', function(){
  const all = [...document.querySelectorAll('#clientList .client-check')];
  const shouldSelect = all.some(cb => !cb.checked);
  all.forEach(cb => cb.checked = shouldSelect);
  this.textContent = shouldSelect ? 'Unselect All' : 'Select All';
  updateSelectedCount();
});
document.addEventListener('change', (e)=>{
  if (e.target.classList.contains('client-check')) updateSelectedCount();
});

// ---------- Share: Open Modal ----------
$(document).on('click', '.btn-share', async function(){
  const id = $(this).data('id');
  const product = productsById.get(String(id));
  if (!product) return;

  // store product id & name
  $('#shareProductId').val(product._id);
  const nameBadge = document.getElementById('shareProductNameBadge');
  nameBadge.textContent = product.name;
  nameBadge.hidden = false;

  // prefill message from server
  try{
    const res = await fetch(`/products/share/default_message?product_id=${encodeURIComponent(product._id)}`);
    const data = await res.json();
    if (data && data.success) {
      $('#shareMessage').val(data.message);
    } else {
      $('#shareMessage').val(`Price update ‚Äî ${product.name}\nS-Price: GHS ${Number(product.s_price).toFixed(2)}\nP-Price: GHS ${Number(product.p_price).toFixed(2)}`);
    }
  }catch{
    $('#shareMessage').val(`Price update ‚Äî ${product.name}\nS-Price: GHS ${Number(product.s_price).toFixed(2)}\nP-Price: GHS ${Number(product.p_price).toFixed(2)}`);
  }

  // try get canonical share URL (fallback to origin)
  try{
    const r = await fetch(`/products/share/url?product_id=${encodeURIComponent(product._id)}`);
    const j = await r.json();
    document.getElementById('shareUrl').value = (j && j.url) ? j.url : location.origin;
  }catch{
    document.getElementById('shareUrl').value = location.origin;
  }

  // load clients
  await loadClients();

  // reset modal state
  setChannel('whatsapp');
  $('#clientSearch').val('');
  $('#btnSelectAll').text('Select All');
  lastBuiltLinks = [];

  new bootstrap.Modal(document.getElementById('shareModal')).show();
  setTimeout(()=> document.getElementById('shareMessage').focus(), 300);
});

// Utilities
function enc(s){ return encodeURIComponent(s || ''); }

// ---------- Share: Submit ----------
$('#shareForm').on('submit', async function(e){
  e.preventDefault();
  const product_id = $('#shareProductId').val();
  const message = $('#shareMessage').val().trim();
  const shareUrl = $('#shareUrl').val() || location.origin;

  if (!message) { toast('Message is required','warning'); return; }

  const selected = Array.from(document.querySelectorAll('#clientList .client-check:checked'));
  const client_ids = selected.map(cb => cb.value);
  const waNumbers = selected.map(cb => cb.dataset.wa).filter(Boolean);

  try {
    if (currentChannel === 'whatsapp') {
      if (!client_ids.length) { toast('Select at least one client','warning'); return; }
      const res = await fetch('/products/share/build', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ product_id, message, client_ids })
      });
      const data = await res.json();
      if (!data?.success || !Array.isArray(data.links) || !data.links.length){
        toast('No WhatsApp links returned','danger'); return;
      }
      lastBuiltLinks = data.links.map(x => x.url);
      data.links.forEach((lk, i)=> setTimeout(()=> window.open(lk.url, '_blank'), i * 250));
      // optional fire-and-forget log
      fetch('/products/share/log', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ product_id, client_ids, message, channels:['whatsapp'] })
      });
      toast('Opening WhatsApp chats‚Ä¶','success');
      bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
      return;
    }

    if (currentChannel === 'facebook') {
      // Facebook needs a URL; we also pass the message as quote
      const fb = `https://www.facebook.com/sharer/sharer.php?u=${enc(shareUrl)}&quote=${enc(message)}`;
      window.open(fb, '_blank');
      toast('Opening Facebook‚Ä¶','success');
      bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
      return;
    }

    if (currentChannel === 'telegram') {
      const tg = `https://t.me/share/url?url=${enc(shareUrl)}&text=${enc(message)}`;
      window.open(tg, '_blank');
      toast('Opening Telegram‚Ä¶','success');
      bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
      return;
    }

    if (currentChannel === 'sms') {
      if (!waNumbers.length) { toast('Select at least one client','warning'); return; }
      // open one sms composer per selected number (platform support varies)
      waNumbers.forEach((num, i)=>{
        const smsUrl = `sms:${encodeURIComponent(num)}?&body=${enc(message)}`;
        setTimeout(()=> window.open(smsUrl, '_blank'), i * 250);
      });
      toast('Opening Messages‚Ä¶','success');
      bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
      return;
    }

    if (currentChannel === 'email') {
      const subj = 'Price update';
      const mailto = `mailto:?subject=${enc(subj)}&body=${enc(message + '\\n\\n' + shareUrl)}`;
      window.location.href = mailto;
      toast('Opening Mail‚Ä¶','success');
      bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
      return;
    }

  } catch(err){
    console.error(err);
    toast('Sharing failed','danger');
  }
});

// Copy helpers
document.getElementById('btnCopyMessage').addEventListener('click', async ()=>{
  try {
    await navigator.clipboard.writeText(document.getElementById('shareMessage').value);
    toast('Message copied','success');
  } catch { toast('Copy failed','danger'); }
});

document.getElementById('btnCopyLinks').addEventListener('click', async ()=>{
  if (!lastBuiltLinks.length) { toast('No links yet ‚Äî click Share via WhatsApp first','warning'); return; }
  try {
    await navigator.clipboard.writeText(lastBuiltLinks.join('\\n'));
    toast('All WhatsApp links copied','success');
  } catch { toast('Copy failed','danger'); }
});

// ---------- Init ----------
$(document).ready(loadProducts);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
