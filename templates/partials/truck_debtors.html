<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Truck Debtors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    h4 {
      font-weight: 600;
      color: #dc3545;
    }
    .summary-badge {
      font-size: 0.75rem;
      background-color: #e2e6ea;
      color: #495057;
      border-radius: 0.25rem;
      padding: 0.25rem 0.5rem;
      font-weight: 500;
    }
    .filter-form {
      background: #ffffff;
      border: 1px solid #dee2e6;
      padding: 1.2rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .table th, .table td {
      vertical-align: middle;
    }
    @media (max-width: 768px) {
      .filter-form .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="container py-4">
  {% if not partial %}
  <h4 class="mb-4"><i class="bi bi-truck text-danger me-2"></i>Truck Debtors Summary</h4>

  <!-- Filter Form -->
  <form id="filterForm" class="filter-form row g-3 align-items-end">
    <div class="col-md-4 col-sm-6">
      <label for="search" class="form-label">Search Client</label>
      <input type="text" name="search" id="search" class="form-control" placeholder="Name or Phone">
    </div>
    <div class="col-md-4 col-sm-6">
      <div class="form-check mt-4 pt-2">
        <input class="form-check-input" type="checkbox" name="unpaid_only" id="unpaidOnly" {% if unpaid_only %}checked{% endif %}>
        <label class="form-check-label" for="unpaidOnly">Unpaid Only</label>
      </div>
    </div>
    <div class="col-md-4 col-sm-12">
      <button type="submit" class="btn btn-danger w-100"><i class="bi bi-funnel-fill me-1"></i>Filter</button>
    </div>
  </form>

  <div id="debtorsTableContainer">
  {% endif %}

    <!-- Debtors Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle text-center">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Client</th>
            <th>Orders</th>
            <th>Total Debt (GHS)</th>
            <th>Total Paid</th>
            <th>Amount Left</th>
            <th>Total Expense</th>
            <th>Settled Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for d in debtors %}
          <tr>
            <td>{{ loop.index + ((current_page - 1) * 10) }}</td>
            <td class="text-start">
              <strong>{{ d.client_name }}</strong><br>
              <small class="text-muted">{{ d.client_phone }}</small>
            </td>
            <td><span class="summary-badge">{{ d.order_count }} Order{{ 's' if d.order_count > 1 }}</span></td>
            <td class="text-primary">{{ "%.2f"|format(d.total_debt) }}</td>
            <td class="text-success">{{ "%.2f"|format(d.total_paid) }}</td>
            <td class="text-danger">{{ "%.2f"|format(d.amount_left) }}</td>
            <td class="text-secondary">{{ "%.2f"|format(d.total_expense) }}</td>
            <td class="text-dark">{{ "%.2f"|format(d.settled_amount) }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-muted py-4">No debtors found for current filters.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  {% if not partial %}
  </div>
</div>

<script>
  document.getElementById('filterForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const search = document.getElementById('search').value;
    const unpaidOnly = document.getElementById('unpaidOnly').checked;

    const params = new URLSearchParams({
      search: search,
      unpaid_only: unpaidOnly
    });

    fetch(`/truck_debtors/ajax?${params.toString()}`)
      .then(res => res.text())
      .then(html => {
        document.getElementById('debtorsTableContainer').innerHTML = html;
      })
      .catch(err => {
        console.error("Error loading data:", err);
      });
  });

  // Auto-submit on checkbox toggle
  document.getElementById('unpaidOnly').addEventListener('change', () => {
    document.getElementById('filterForm').dispatchEvent(new Event('submit'));
  });
</script>
{% endif %}
</body>
</html>
